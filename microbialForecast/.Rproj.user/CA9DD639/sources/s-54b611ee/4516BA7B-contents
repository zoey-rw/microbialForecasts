soilData_in <- readRDS("/projectnb2/talbot-lab-data/zrwerbin/interactions/data/HARV_DAMM_all_data.rds")
N_rate_data <- readRDS("/projectnb2/talbot-lab-data/zrwerbin/interactions/data/HARV_DAMM_val_N_rates.rds")

# Read in soil data
bd_ps <- readRDS("/projectnb2/talbot-lab-data/zrwerbin/temporal_forecast/data/raw/bulkDensity_allsites.rds")

# label horizons by O or M
bd_ps$horizon <- ifelse(grepl("O", bd_ps$horizonName), "O", "M")

# Subset to shallower bulk density measurements
bd_shallow <- bd_ps[bd_ps$bulkDensTopDepth < 25 & bd_ps$bulkDensBottomDepth < 35,]

# Use third bar measurements whenever possible (user guide recommends that)
bd_shallow$bulkDens <- ifelse(!is.na(bd_shallow$bulkDensThirdBar),
                              bd_shallow$bulkDensThirdBar, bd_shallow$bulkDensFieldMoist)

# Multiply by <2mm fraction (for the same horizon) to get more accurate value
bd_shallow$bulkDensFineFrag <- bd_shallow$bulkDens * bd_shallow$fineFragPercent

## Summarize by site or plot
#site_plot_bd <- bd_shallow %>% group_by(siteID, horizon) %>%  #depth) %>%
#  mutate(mean_bd_FineFrag_site = mean(bulkDensFineFrag, na.rm=T),
#         mean_topDepth_site = mean(bulkDensTopDepth, na.rm=T),
#         mean_bottomDepth_site = mean(bulkDensBottomDepth, na.rm=T)) %>%
#  ungroup() %>%
#  group_by(plotID, horizon) %>%  #depth) %>%
#  mutate(mean_bd_FineFrag_plot = mean(bulkDensFineFrag, na.rm=T)) %>%
#  distinct(plotID, horizon, .keep_all=TRUE) %>% as.data.frame()

# Get mean bulk density for Harvard Forest: .14 for organic horizon, .87 for mineral
site_plot_bd[,c("siteID","horizon","mean_bd_FineFrag_site")] %>% unique() %>% filter(siteID=="HARV")

bd_site_mean = bd_shallow[,c("siteID","horizon","bulkDensFineFrag")] %>%
	unique() %>% filter(siteID=="HARV") %>%
	group_by(horizon) %>% summarize(bd = mean(bulkDensFineFrag, na.rm=T))

bd_plot_mean = bd_shallow[,c("siteID","plotID","horizon","bulkDensFineFrag")] %>%
	unique() %>% filter(siteID=="HARV") %>%
	group_by(horizon, plotID) %>% summarize(bd = mean(bulkDensFineFrag, na.rm=T))

site_plot_bd$dateID <- substr(site_plot_bd$collectDate, 1, 7)


# Merge with plot bulk density valies
soilData <- merge(soilData_in, bd_site_mean, all.x  = T)
#soilData <- merge(soilData_in, bd_plot_mean, all.x  = T)
soilData$vol_SoilMoisture <- soilData$soilMoisture * soilData$bd #* .1

ggplot(soilData) + geom_point(aes(x = vol_SoilMoisture, y =sensor_moisture), alpha=.5) + geom_abline()

#soilData <- merge(soilData_in, site_plot_bd[,c("siteID", "plotID","horizon","mean_bd_FineFrag_plot")], all.x  = T)
#soilData <- merge(soilData, site_plot_bd[,c("siteID","horizon","mean_bd_FineFrag_site")], all.x  = T)
# Use plot-level bulk density.
#soilData$vol_SoilMoisture <- soilData$soilMoisture * soilData$mean_bd_FineFrag_plot
#soilData$vol_SoilMoisture_site <- soilData$soilMoisture * soilData$mean_bd_FineFrag_site

#N_rate_data <- merge(N_rate_data, soilData[,c("plotID","horizon",#"vol_SoilMoisture_site",
#																							"vol_SoilMoisture","dateID")],
#                      by = c("plotID","horizon","dateID"), all.x=T)
# soilData_in$sensor_moisture = NULL
# soilData_out <- merge(soilData_in, soilData[,c("plotID","horizon",#"vol_SoilMoisture_site",
# 																							 "vol_SoilMoisture","sensor_moisture","dateID")], by=c("plotID","horizon","dateID"))


saveRDS(N_rate_data, "/projectnb2/talbot-lab-data/zrwerbin/interactions/data/HARV_DAMM_val_N_rates2.rds")
saveRDS(soilData, "/projectnb2/talbot-lab-data/zrwerbin/interactions/data/HARV_DAMM_all_data2.rds")

#Harvard forest parameters from Abramoff et al. 2017

parameters <- read.csv("/projectnb/talbot-lab-data/zrwerbin/interactions/damm/DAMM-MCNiPv0/parameters.csv")
p = parameters$fitted2009 #select either default parameters or fitted to 2009 flux data
bd <- p[25]                           #bulk density
pd <- p[26]                           #particle density
porosity = 1 - bd/pd            #calculate porosity: .697

# Liquid diffusion: Equation S2.45 from Sihi et al., who cites Davidson et al., 2012
diffusion_liquid = 1/(porosity^3)

# soilMoisture: volumetric
# availability of aqueous substrates to enzymatic active sites, micromol/L
# Equation S2.47 from Sihi et al., used for C, NH4, NO3
substrate_avail = substrate * diffusion_liquid * (soilMoisture/100)^3


calc_substrate_avail = function(substrate, soilMoisture, porosity = .697) {
	# Liquid diffusion: Equation S2.45 from Sihi et al., who cites Davidson et al., 2012
	diffusion_liquid = 1/(porosity^3)
	substrate_avail = substrate * diffusion_liquid * (soilMoisture/100)^3
	return(substrate_avail)
}

# tortuosity of diffusion pathway for gases
# Equation 8 from Sihi et al 2021
alpha_4_3 = (porosity - (soilMoisture/100))^(4/3) * (soilTemperature + 273.15/293.15)^1.75

# Air diffusivity constant from Eq S2.42 from Sihi et al.
Dgas = .139 # cm-2 s-1
# Equation 9 from Sihi et al 2021
gas_diff = Dgas * atmospheric_concentration * alpha_4_3



soilData_harv_all <- readRDS("/projectnb2/talbot-lab-data/zrwerbin/interactions/data/HARV_DAMM_all_data2.rds")  %>% filter(soilInorganicNugPerGram_initial < 25) %>% distinct(.keep_all = T)

soilData_harv = soilData_harv_all %>% select(sampleID, horizon, plotID, soilInorganicNugPerGram_initial, soilAmmoniumNugPerGram_initial, soilNitrateNitriteNugPerGram_initial,
																		nitrogenPercent, organicCPercent, CNratio,
																		litterDepth,standingWaterDepth, soilMoisture, soilInCaClpH, soilTemp, vol_SoilMoisture, sensor_moisture) %>% distinct(.keep_all = T)

simple_df <- soilData_harv_all %>% mutate(porosity = 1 - soilData_harv_all$bd/pd,
																					diffusion_liquid = 1/(porosity^3),
																					avail_ammonium =
														 	calc_substrate_avail(soilAmmoniumNugPerGram_initial,
														 											 soilMoisture = vol_SoilMoisture*100,
														 											 porosity = porosity),
														 avail_nitrate_nitrite =
														 	calc_substrate_avail(soilNitrateNitriteNugPerGram_initial,
														 											 soilMoisture = vol_SoilMoisture*100,
														 											 porosity = porosity),
														 moisture = vol_SoilMoisture) %>%
	select(sampleID,porosity,soilNitrateNitriteNugPerGram_initial,avail_nitrate_nitrite,soilAmmoniumNugPerGram_initial,avail_ammonium,diffusion_liquid,moisture)




obs <- simple_df %>% mutate(moisture = round(moisture, 2),
														diffusion = round(diffusion_liquid, 2),
														ammonium = round(avail_ammonium, 2),
														nitrate = round(avail_nitrate_nitrite, 2),
														#diffusion = ifelse(horizon=="O",1e-6, 10e-6),
														id = paste0('sim_diff_', diffusion, '_nh4_',
																				ammonium,'_no3_', nitrate,'_mois_',moisture))


obs <- simple_df %>% mutate(moisture = cut(initMoisture, breaks = c(0,.5,1,2,3,4,5,6),
																								labels = c(.5,1,2,3,4,5,6),	include.lowest = TRUE),
																 diffusion = cut(initMoisture, breaks = c(0,.5,1,2,3,4,5,6),
																 								labels = c(5e-6,1e-6,2e-6,3e-6,4e-6,5e-6,6e-6),	include.lowest = TRUE),
																 ammonium = cut(avail_ammonium, breaks = c(0,.1,.2,.3,.4,.5,.6,.7,.8,.9,1,1.5,3),
																 							 labels = c(.1,.2,.3,.4,.5,.6,.7,.8,.9,1,1.5,3),	include.lowest = TRUE),
																 nitrate = cut(initNitrateNitrite, breaks = c(0,.1,.2,.3,.4,.5,.6),
																 							labels = c(.1,.2,.3,.4,.5,.6),	include.lowest = TRUE),
																 #diffusion = ifelse(horizon=="O",1e-6, 10e-6),
																 id = paste0('sim_diff_', diffusion, '_nh4_',
																 						ammonium,'_no3_', nitrate,'_mois_',moisture))


sim_categories <- obs %>%
	distinct(id, .keep_all=T)
rownames(sim_categories) <- NULL
sim_categories$rownames <- 1:nrow(sim_categories)


write.csv(sim_categories, "/projectnb/talbot-lab-data/metabolic_models/scripts/N_cycle_sim/data/simulation_categories.csv")

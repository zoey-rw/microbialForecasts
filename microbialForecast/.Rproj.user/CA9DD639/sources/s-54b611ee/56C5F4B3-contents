library(sp) 
library(ggridges)

s <- "diff_06_nh4_7"
sim_directory <- "/projectnb2/talbot-lab-data/zrwerbin/interactions/data/simulation_output"


# Let's pull from the simulations where each of the inputs was multiplied by two
scenarios <- list.files(sim_directory, pattern = "exp_sim_")
s <- scenarios[[1]]

biom_list <- list()

for (s in scenarios) {
	print(s)
dir_to_search <- file.path(sim_directory, s)


files <- file.info(list.files(dir_to_search, pattern = "^biomass", full.names = T))
if (nrow(files)==0) next()
newest_biom_path <- rownames(files)[which.max(files$mtime)]
biomass_orig <- data.table::fread(newest_biom_path, data.table = F, col.names = c("timepoint","x","y","modelID","abundance"))


total_files <- file.info(list.files(dir_to_search, pattern = "^total_biomass", full.names = T))
newest_tot_biom_path <- rownames(total_files)[which.max(total_files$mtime)]
tot_biomass_orig <- data.table::fread(newest_tot_biom_path, data.table = F, fill = T)

if (ncol(tot_biomass_orig) < 16) next()


colnames(tot_biomass_orig) <- c("cycle","Nitrosomonas_europaea_AOB",	"Nitrosomonas_eutropha_AOB",	"Nitrosospira_multiformis_AOB",	"Nitrosococcus_oceani_AOB",	"Nitrospira_defluvii_NOB",	"Nitrobacter_winogradskyi_NOB",	"Nitrobacter_hamburgensis_NOB",	"Nitrospina_gracilis_NOB",	"Geobacter_metallireducens",	"Methanosarcina_barkeri",	"Salmonella_typhimurium",	"Escherichia_coli",	"Pseudomonas_stutzeri",	"Pseudomonas_putida",	"Nitrospira_moscoviensis_NOB")

timestep <- 2
tot_biom_long <- tot_biomass_orig %>% pivot_longer(cols = 2:ncol(tot_biomass_orig))
tot_biom_long$hour <- tot_biom_long$cycle*timestep
tot_biom_long$id = s

biom_list[[s]] <- tot_biom_long

}

biom_df <- do.call(rbind, biom_list)

biom_wide <- biom_df %>% pivot_wider(id_cols = c("id", "cycle")) %>% mutate(id = gsub("exp_","", id))
																		 

biom_wide <- biom_wide %>% mutate(total_AOB = Nitrosomonas_europaea_AOB + Nitrosomonas_eutropha_AOB +  Nitrosospira_multiformis_AOB + Nitrosococcus_oceani_AOB,
																						 total_NOB = Nitrospira_defluvii_NOB + Nitrobacter_winogradskyi_NOB + Nitrobacter_hamburgensis_NOB + Nitrospina_gracilis_NOB + Nitrospira_moscoviensis_NOB,
																						 total_NB = total_AOB + total_NOB,
																	total_biomass = total_NB + Methanosarcina_barkeri + Pseudomonas_stutzeri + Pseudomonas_putida + Escherichia_coli + Geobacter_metallireducens + Salmonella_typhimurium,
																	relative_NB = total_NB/total_biomass,
																	relative_NOB = total_NOB/total_biomass,
																	relative_AOB = total_AOB/total_biomass)
#values_from = c(total_AOB, total_NOB, total_NB, value)

# new_master df comes from the "predict_n_flux.r"
obs <- read.csv("/projectnb2/talbot-lab-data/zrwerbin/interactions/data/obs_params.csv")
new_master_obs <- left_join(new_master, obs, by= c("sampleID"))


biom_wide_final <- biom_wide %>% filter(cycle == 100)
biom_wide_final[,3:ncol(biom_wide_final)] <- as.data.frame(scale(biom_wide_final[,3:ncol(biom_wide_final)]))
obs_biom <- left_join(new_master_obs, biom_wide_final, by= "id")
obs_biom$nitrifier_scaled <- scale(obs_biom$nitrifier_genera.y)
summary(lm(nitrifier_scaled ~ total_AOB, obs_biom, na.action = na.omit))
summary(lm(nitrifier_scaled ~ total_NOB, obs_biom, na.action = na.omit))
summary(lm(nitrifier_scaled ~ total_NB, obs_biom, na.action = na.omit))
summary(lm(nitrifier_scaled ~ relative_NB, obs_biom, na.action = na.omit))
summary(lm(nitrifier_scaled ~ relative_NOB, obs_biom, na.action = na.omit))
summary(lm(nitrifier_scaled ~ relative_AOB, obs_biom, na.action = na.omit))
summary(lm(nitrifier_scaled ~ Nitrosospira_multiformis_AOB, obs_biom, na.action = na.omit))
summary(lm(nitrifier_scaled ~ Nitrospira_defluvii_NOB, obs_biom, na.action = na.omit))
summary(lm(nitrifier_scaled ~ Nitrospira_moscoviensis_NOB, obs_biom, na.action = na.omit))
summary(lm(nitrifier_scaled ~ Nitrosospira_multiformis_AOB, obs_biom, na.action = na.omit))

# at cycle == 100
summary(lm(formula = nitrifier_scaled ~ total_NOB, data = obs_biom, 
	 na.action = na.omit))
summary(lm(formula = nitrifier_scaled ~ total_NB, data = obs_biom, 
	 na.action = na.omit))

# at cycle == 50, r2=.02
# at cycle == 30, r2=.024 for total NOB

# maybe at cycle 30 as well
lm(formula = nitrifier_scaled ~ total_NOB, data = obs_biom, na.action = na.omit)

fam_nitrospira$nitrospira_fam_scaled <- scale(fam_nitrospira$percentage)
# fam_nitrospira$sampleID_lowercase <- tolower(fam_nitrospira$sampleID)
# new_master_obs$sampleID_lowercase <- tolower(new_master_obs$geneticSampleID.x)
new_master_obs_nitr <- merge(new_master_obs, fam_nitrospira, by=c("siteID","horizon","plot_date"))

biom_wide_final <- biom_wide %>% filter(cycle == 100)
biom_wide_final[,3:ncol(biom_wide_final)] <- as.data.frame(scale(biom_wide_final[,3:ncol(biom_wide_final)]))
obs_nitro_biom <- left_join(new_master_obs_nitr, biom_wide_final, by= "id")

summary(lm(formula = nitrospira_fam_scaled ~ total_NB, data = obs_nitro_biom, na.action = na.omit))

# VISUALIZE family abundances by predictions
ggscatter(obs_nitro_biom, x = "total_NB", y = "nitrospira_fam_scaled",  
					add = "reg.line", conf.int = TRUE, shape = 16, size = 3) +
	stat_cor(aes(label = paste(..rr.label.., ..p.label.., sep = "~`,`~")),
					 #label.x = -.5, 
					 #label.y = .6, 
					 size=7) + 
	theme_minimal(base_size=20) + 
	xlab("Predicted nitrifier abundance (scaled)") + 
	ylab("Observed Nitrospiraceae abundance (scaled)") + 
	ggtitle("Predicting nitrifying bacterial abundances") + 
	geom_abline(intercept = 0, slope = 1, color = "red", linetype = 2)# + xlim(c(-.6,1)) + ylim(-.4,1.0)




	library(ggrepel)

# VISUALIZE biomass over time
tot_biom_long %>% filter(!grepl("total_",  name)) %>%  group_by(name) %>% 
	mutate(label = if_else(value == max(value), gsub("_|_NOB|_AOB", " ", as.character(name)), NA_character_)) %>% ungroup() %>% 
	ggplot(aes(x = hour, y = value, color = as.factor(name))) + geom_line(size = 2, show.legend = F) + 
		ylab("Biomass (g)") +
		theme_bw(base_size = 25) + #labs(color="Species") + 
		geom_label_repel(aes(label = label), #nudge_x = 1, 
										 nudge_y=.2, force = 2,
										 na.rm = TRUE, show.legend = F, x = 600, 
										 size=6)






















nitrospira <- biomass_orig %>% filter(modelID == "Nitrospira.cmd")
#final_cycle <- nitrospira %>% filter(timepoint == max(timepoint))
final_cycle <- nitrospira %>% filter(timepoint == 600)
final_cycle <- nitrospira %>% filter(timepoint == 550)
final_cycle <- nitrospira %>% filter(timepoint == 500)
final_cycle <- nitrospira %>% filter(timepoint == 100)


#neuro <- final_cycle %>% filter(modelID %in% c("Nitrospira.cmd"))
coordinates(final_cycle) <- c("x", "y") # use x and y columns as the lat/long 
plot(final_cycle) 

ggplot(data=neuro@data) +
	geom_point(aes(x=neuro@coords[,"x"],y=-neuro@coords[,"y"], 
								 size = neuro@data[,"abundance"])) + 
	theme_minimal() + xlab("") + ylab("Soil depth (.1 cm)") 


by_depth <- final_cycle %>%  group_by(modelID, y) %>% summarize(tot = sum(abundance))

ggplot(by_depth) + geom_point(aes(x = -y, y = tot)) + facet_grid(~modelID) + coord_flip()

#ggplot(by_depth) + geom_bar(aes(x =tot)) + facet_grid(~modelID) + coord_flip()

by_depth$depth <- cut(x=by_depth$y, breaks=seq(from=0, to=100, by = 10),
											labels = c(1:10), 
											include.lowest = T)

by_depth_sum <- by_depth %>% group_by(depth) %>% summarize(total = sum(tot))
ggplot(by_depth_sum, aes(x = depth, y = total)) + 
	#ylab("depth") +
	geom_bar(stat = "identity") + 
	coord_flip()


# Faccio il plot dei bin
barplot(height = Bydepth, xlab = "depth", ylab = "occurence")


ggplot(by_depth, aes(y = tot,x = -y)) + ylab("depth") +
	geom_bar(stat = "identity") + coord_flip() +
	facet_wrap(~modelID, drop=T#, scales="free"
	) #+ scale_fill_gradient(low = "blue", high = "red") +  theme_ridges(font_size = 13, grid = TRUE) 

library(ggridges)
ggplot(by_depth, aes(x = y, y = tot)) + geom_density_ridges()
ggplot(by_depth, aes(x = y, y = tot, group = y)) + geom_density_ridges()
ggplot(by_depth, aes(x = tot, y = y, group = y)) + geom_density_ridges()

ggplot(by_depth) + 
	geom_density_ridges(aes(y = y, 
													x = tot, fill = stat(y)), 
											scale = 2, rel_min_height = .01) + #coord_flip() +
	facet_grid(~name, scales="free") + scale_fill_gradient(low = "blue", high = "red") +  theme_ridges(font_size = 13, grid = TRUE) 
ridgeplot


ggplot(data=by_depth, aes(x=y, group=cut, fill=cut)) +
	geom_density(adjust=1.5)

biomass_wide <- biomass_orig %>% pivot_wider(names_from = "modelID", values_from = "abundance", id_cols = c(1:3), values_fn = length)
biomass_wide <-	as.data.frame(biomass_wide)
coordinates(biomass_orig) <- c("x", "y") # use x and y columns as the lat/long 

spplot(biomass_wide, c("iJN746.cmd", "iYO844.cmd", "iAF692.cmd", "iMM904.cmd")) # easy way to plot side by side maps

flux_fp <- "/projectnb2/talbot-lab-data/zrwerbin/interactions/data/simulation_output/nitro/flux_out_0x2ad10ad04af0"
flux_orig <- data.table::fread(flux_fp, fill = T, header = F)
flux_orig <- data.table::fread("/projectnb2/talbot-lab-data/zrwerbin/interactions/flux_out_0x2b14e5097550_0x2b14e5097af0",sep="\s", fill = T)
flux_lines <- readLines("/projectnb2/talbot-lab-data/zrwerbin/interactions/flux_out_0x2b14e5097550_0x2b14e5097af0")

head(flux_orig)

# Linear models of N-flux data
source("/projectnb/talbot-lab-data/zrwerbin/temporal_forecast/functions/helperFunctions.r")
library(tidyverse)
library(Metrics)


# Read in soil data
soilData <- readRDS("/projectnb2/talbot-lab-data/zrwerbin/interactions/data/NEON_soilCovariates_allsites.rds")
soilData$netAmmugPerGramPerDay = soilData$netNminugPerGramPerDay -
	soilData$netNitugPerGramPerDay
soilData_harv <- soilData %>% filter(siteID=="HARV" & !is.na(netNitugPerGramPerDay) & !is.na(soilMoisture))
soilData_harv$plot_date <- parseNEONsampleIDs(soilData_harv$sampleID)$plot_date


# Read in genomic data
gene_counts <- readRDS("/projectnb2/talbot-lab-data/zrwerbin/interactions/data/N_gene_counts.rds")
gene_counts <- cbind(gene_counts, parseNEONsampleIDs(gene_counts$sampleID))
gene_counts_plot <- gene_counts %>% group_by(Pathway, plotID, horizon) %>%
	summarize(Pathway_mean = mean(rel)) %>%
	pivot_wider(id_cols = c(plotID, horizon), names_from = Pathway,values_from = Pathway_mean)

# Read in abundances from nitrifier genera
nitr_abun2 <- readRDS("/projectnb2/talbot-lab-data/zrwerbin/interactions/data/nitrifiers_genus_16S.rds")
nitr_abun2 <- nitr_abun2 %>% mutate(nitrifier_genera = candidatus.nitrosotalea + candidatus.nitrotoga + nitrolancea +
																			nitrosomonadaceae_genus + nitrosospira + nitrospira) #%>% select(nitrifier_genera)
nitr_abun2$geneticSampleID <- rownames(nitr_abun2)
nitr_abun2$geneticSampleID <- gsub("-DNA[123]","",nitr_abun2$geneticSampleID)
nitr_abun2$nitrifier_scaled <- scale(nitr_abun2$nitrifier_genera)

# Merge dataframes
nitr_abun2$plot_date <- parseNEONsampleIDs(nitr_abun2$geneticSampleID)$plot_date
nitr_abun2$horizon <- parseNEONsampleIDs(nitr_abun2$geneticSampleID)$horizon
nitr_abun2 <- nitr_abun2 %>% select(plot_date, horizon, nitrifier_genera, nitrifier_scaled)

library(jtools)
library(MuMIn)
options(na.action = "na.fail")
coeff_name_key <- c("Soil carbon:nitrogen" = "CNratio",
										"Soil pH" = "soilInCaClpH",
										"Soil moisture" = "soilMoisture",
										"Soil temperature" = "soilTemp",
										"delta15 Nitrogen" = "d15N",
										"Soil nitrate/nitrite" = "initNitrateNitrite",
										"Metabolic model \n simulation" = "nitr",
										"Metabolic model \n simulation" = "nmin",
										"% Nitrogen" = "nitrogenPercent",
										"Nitrifier abundance" = "nitrifier_scaled",
										"Soil ammonium" = "initAmmonium",
										"Soil horizon" = "horizon",
										"Functional genes" = "functional_genes")


RMSE_out_list <- list()

simple <- soilData %>% select(netNminugPerGramPerDay,
															netAmmugPerGramPerDay, netNitugPerGramPerDay,
															soilMoisture, soilInCaClpH, d15N, CNratio,nitrogenPercent,
															initAmmonium, initNitrateNitrite, soilTemp) %>% drop_na()
simple <- scale(simple) %>% as.data.frame()

#### NITRIFICATION - ENV ONLY #####



# Fit all parameter combinations
all.parms<-lm(netNitugPerGramPerDay ~ soilMoisture + initAmmonium  + CNratio +
								soilInCaClpH + nitrogenPercent + d15N + initNitrateNitrite  +
								soilTemp, data = simple)

results<-dredge(all.parms)
#results<-dredge(all.parms, subset= !(d15N && nitrogenPercent))
MA.ests<-model.avg(results, subset= delta <= 3)
importance(MA.ests); summary(MA.ests)
best_model <- get.models(results, delta == 0)
effs <- plot_summs(best_model, scale = TRUE, robust=T, coefs = coeff_name_key)
effs <- effs + theme_classic(base_size = 20) + ylab("Coefficient")

simple$env_pred <- predict(best_model[[1]])
scatter <- ggscatter(simple, x = "env_pred", y = "netNitugPerGramPerDay",
					add = "reg.line", conf.int = TRUE, shape = 21, size = 3) +
	stat_cor(aes(label = paste(..rr.label.., ..p.label.., sep = "~`,`~")),
					 label.x = -.5,
					 label.y = 5,
					 size=7) + theme_minimal(base_size=20) +
	xlab("Predicted nitrification (ug/g/day)") + ylab("Observed nitrification (ug/g/day)") +
	ggtitle("Environmental predictors") + geom_abline(intercept = 0, slope = 1, color = "red", linetype = 2)

RMSE_out_list$Nitr_env <- rmse(simple$netNitugPerGramPerDay, simple$env_pred)
#####
effs
scatter

##### N MINERALIZATION - ENV ONLY #####
all.parms<-lm(netNminugPerGramPerDay ~
								soilMoisture + initAmmonium  + CNratio +
								soilInCaClpH + nitrogenPercent + d15N +
								initNitrateNitrite  +
								soilTemp, data = simple)

results<-dredge(all.parms)
#results<-dredge(all.parms, subset= !(d15N && nitrogenPercent))
MA.ests<-model.avg(results, subset= delta <= 3)
importance(MA.ests); summary(MA.ests)
best_model <- get.models(results, delta == 0)
effs <- plot_summs(best_model, scale = TRUE, robust=T, coefs = coeff_name_key)
effs <- effs + theme_classic(base_size = 20) + ylab("Coefficient")

simple$env_pred <- predict(best_model[[1]])
scatter <- ggscatter(simple, x = "env_pred", y = "netNminugPerGramPerDay",
										 add = "reg.line", conf.int = TRUE, shape = 21, size = 3) +
	stat_cor(aes(label = paste(..rr.label.., ..p.label.., sep = "~`,`~")),
					 label.x = 0,
					 label.y = 7,
					 size=7) + theme_minimal(base_size=20) +
	xlab("Predicted N mineralization (ug/g/day)") + ylab("Observed N mineralization (ug/g/day)") +
	ggtitle("Environmental predictors") + geom_abline(intercept = 0, slope = 1, color = "red", linetype = 2)

RMSE_out_list$Nmin_env <- rmse(simple$netNminugPerGramPerDay, simple$env_pred)
#####
scatter
effs

#### AMMONIFICATION - ENV ONLY #####
all.parms<-lm(netAmmugPerGramPerDay ~
								soilMoisture + initAmmonium  + CNratio +
								soilInCaClpH + nitrogenPercent + d15N +
								initNitrateNitrite  +
								soilTemp, data = simple)

results<-dredge(all.parms)
#results<-dredge(all.parms, subset= !(d15N && nitrogenPercent))
MA.ests<-model.avg(results, subset= delta <= 3)
importance(MA.ests); summary(MA.ests)
best_model <- get.models(results, delta == 0)
effs <- plot_summs(best_model, scale = TRUE, robust=T, coefs = coeff_name_key)
effs <- effs + theme_classic(base_size = 20) + ylab("Coefficient")

simple$env_pred <- predict(best_model[[1]])
scatter <- ggscatter(simple, x = "env_pred", y = "netAmmugPerGramPerDay",
										 add = "reg.line", conf.int = TRUE, shape = 21, size = 3) +
	stat_cor(aes(label = paste(..rr.label.., ..p.label.., sep = "~`,`~")),
					 label.x = 0,
					 label.y = 7.5,
					 size=7) + theme_minimal(base_size=20) +
	xlab("Predicted ammonification (ug/g/day)") + ylab("Observed ammonification (ug/g/day)") +
	ggtitle("Environmental predictors") + geom_abline(intercept = 0, slope = 1, color = "red", linetype = 2)
RMSE_out_list$Amm_env <- rmse(simple$netAmmugPerGramPerDay, simple$env_pred)
#####
effs
scatter

#### NITRIFICATION - ENV and BACTERIAL ABUNDANCE #####

new_master <- inner_join(soilData_harv, nitr_abun2, by = c("plot_date","horizon"))

simple_pathway <- new_master %>% select(netNitugPerGramPerDay, netNminugPerGramPerDay,
																				soilMoisture, soilInCaClpH, d15N, CNratio,nitrogenPercent,
																				initAmmonium, initNitrateNitrite, soilTemp, nitrifier_scaled) %>% drop_na()

simple_pathway <- scale(simple_pathway) %>% as.data.frame()


all.parms<-lm(netNitugPerGramPerDay ~ nitrifier_scaled +
								soilMoisture + initAmmonium  + CNratio +
								soilInCaClpH + nitrogenPercent + d15N +
								initNitrateNitrite  +
								soilTemp, data = simple_pathway)

results<-dredge(all.parms, fixed = "nitrifier_scaled")
#results<-dredge(all.parms, subset= !(d15N && nitrogenPercent))
MA.ests<-model.avg(results, subset= delta <= 3)
importance(MA.ests); summary(MA.ests)
best_model <- get.models(results, delta == 0)
effs <- plot_summs(best_model, scale = TRUE, robust=T, coefs = coeff_name_key)
effs + theme_classic(base_size = 20) + ylab("Coefficient")

simple_pathway$env_path_pred <- predict(best_model[[1]])
ggscatter(simple_pathway, x = "env_path_pred", y = "netNitugPerGramPerDay",
					add = "reg.line", conf.int = TRUE, shape = 21, size = 3) +
	stat_cor(aes(label = paste(..rr.label.., ..p.label.., sep = "~`,`~")),
					 label.x = -2,
					 label.y = .3,
					 size=7) + theme_minimal(base_size=20) +
	xlab("Predicted nitrification (ug/g/day)") + ylab("Observed nitrification (ug/g/day)") +
	ggtitle("Environmental predictors & bacterial abundance") + geom_abline(intercept = 0, slope = 1, color = "red", linetype = 2)


RMSE_out_list$Nitr_env_pathway <- rmse(simple_pathway$netNitugPerGramPerDay, simple_pathway$env_path_pred)
#####


##### N MINERALIZATION - ENV and PATHWAY #####

# Merge dataframes
new_master <- merge(gene_counts_plot, soilData_harv)
simple_pathway <- new_master %>% select(netNitugPerGramPerDay, netNminugPerGramPerDay,
															soilMoisture, soilInCaClpH, d15N, CNratio,nitrogenPercent,
															initAmmonium, initNitrateNitrite, soilTemp,
															functional_genes = `Organic degradation and synthesis `) %>% drop_na()

simple_pathway <- scale(simple_pathway) %>% as.data.frame()


all.parms<-lm(netNminugPerGramPerDay ~ #nitrifier_scaled +
								soilMoisture + initAmmonium  + CNratio +
								soilInCaClpH + nitrogenPercent + d15N +
								initNitrateNitrite + functional_genes +
								soilTemp, data = simple_pathway)

results<-dredge(all.parms, fixed = "functional_genes")
#results<-dredge(all.parms, subset= !(d15N && nitrogenPercent))
MA.ests<-model.avg(results, subset= delta <= 3)
importance(MA.ests); summary(MA.ests)
best_model <- get.models(results, delta == 0)
effs <- plot_summs(best_model, scale = TRUE, robust=T, coefs = coeff_name_key)
effs + theme_classic(base_size = 20) + ylab("Coefficient")

simple_pathway$env_path_pred <- predict(best_model[[1]])
ggscatter(simple_pathway, x = "env_path_pred", y = "netNminugPerGramPerDay",
					add = "reg.line", conf.int = TRUE, shape = 21, size = 3) +
	stat_cor(aes(label = paste(..rr.label.., ..p.label.., sep = "~`,`~")),
					 label.x = 0,
					 label.y = 3,
					 size=7) + theme_minimal(base_size=20) +
	xlab("Predicted N mineralization (ug/g/day)") + ylab("Observed N mineralization (ug/g/day)") +
	ggtitle("Environmental predictors & functional genes") + geom_abline(intercept = 0, slope = 1, color = "red", linetype = 2)

RMSE_out_list$Nmin_env_pathway <- rmse(simple_pathway$netNminugPerGramPerDay, simple_pathway$env_path_pred)
#####


##### N AMMONIFICATION - ENV and PATHWAY #####

# Merge dataframes
new_master <- merge(gene_counts_plot, soilData_harv)
simple_pathway <- new_master %>% select(netNitugPerGramPerDay, netNminugPerGramPerDay,netAmmugPerGramPerDay,
																				soilMoisture, soilInCaClpH, d15N, CNratio,nitrogenPercent,
																				initAmmonium, initNitrateNitrite, soilTemp,
																				functional_genes = `Organic degradation and synthesis `) %>% drop_na()

simple_pathway <- scale(simple_pathway) %>% as.data.frame()


all.parms<-lm(netAmmugPerGramPerDay ~ #nitrifier_scaled +
								soilMoisture + initAmmonium  + CNratio +
								soilInCaClpH + nitrogenPercent + d15N +
								initNitrateNitrite + functional_genes +
								soilTemp, data = simple_pathway)

results<-dredge(all.parms, fixed = "functional_genes")
#results<-dredge(all.parms, subset= !(d15N && nitrogenPercent))
MA.ests<-model.avg(results, subset= delta <= 3)
importance(MA.ests); summary(MA.ests)
best_model <- get.models(results, delta == 0)
effs <- plot_summs(best_model, scale = TRUE, robust=T, coefs = coeff_name_key)
effs <- effs + theme_classic(base_size = 20) + ylab("Coefficient")

simple_pathway$env_path_pred <- predict(best_model[[1]])
scatter <- ggscatter(simple_pathway, x = "env_path_pred", y = "netAmmugPerGramPerDay",
					add = "reg.line", conf.int = TRUE, shape = 21, size = 3) +
	stat_cor(aes(label = paste(..rr.label.., ..p.label.., sep = "~`,`~")),
					 label.x = 0,
					 label.y = 3,
					 size=7) + theme_minimal(base_size=20) +
	xlab("Predicted ammonification (ug/g/day)") + ylab("Observed ammonification (ug/g/day)") +
	ggtitle("Environmental predictors & functional genes") + geom_abline(intercept = 0, slope = 1, color = "red", linetype = 2)

RMSE_out_list$Amm_env_pathway <- rmse(simple_pathway$netAmmugPerGramPerDay, simple_pathway$env_path_pred)
#####
effs
scatter

##### NITRIFICATION - ENV and SIMULATION #####

eval <- readRDS("/projectnb2/talbot-lab-data/zrwerbin/interactions/data/simulation_output/eval_summary.rds")
eval_pred <- eval %>% select(sampleID, moisture, diffusion, ammonium, nitrate, nmin, nitr)
new_master <- merge(eval_pred, soilData_harv)
new_master <- left_join(new_master, nitr_abun2, by = c("plot_date","horizon"))

simple_simulation <- new_master %>% select(netNitugPerGramPerDay, netNminugPerGramPerDay,
																				soilMoisture, soilInCaClpH, d15N, CNratio,
																				nitrogenPercent, `nitrifier_scaled`,
																				initAmmonium, initNitrateNitrite, soilTemp,nmin,nitr) %>% drop_na()
simple_simulation <- scale(simple_simulation) %>% as.data.frame()


# Fit all parameter combinations
all.parms<-lm(netNitugPerGramPerDay ~ soilMoisture + initAmmonium  + CNratio +
								soilInCaClpH  + `nitrifier_scaled` +
								nitrogenPercent + d15N + initNitrateNitrite + nitr, data = simple_simulation)

results<-dredge(all.parms, fixed = "nitr")
#results<-dredge(all.parms, subset= !(d15N && nitrogenPercent))
MA.ests<-model.avg(results, subset= delta <= 3)
importance(MA.ests); summary(MA.ests)
best_model <- get.models(results, delta == 0)
effs <- plot_summs(best_model, scale = TRUE, robust=T, coefs = coeff_name_key)

simple_simulation$env_sim_pred <- predict(best_model[[1]])
scatter <- ggscatter(simple_simulation, x = "env_sim_pred", y = "netNitugPerGramPerDay",
					add = "reg.line", conf.int = TRUE, shape = 21, size = 3) +
	stat_cor(aes(label = paste(..rr.label.., ..p.label.., sep = "~`,`~")),
					 label.x = -2.5,
					 label.y = 1,
					 size=7) + theme_minimal(base_size=20) +
	xlab("Predicted nitrification (ug/g/day)") + ylab("Observed nitrification (ug/g/day)") +
	ggtitle("Environmental predictors & simulation") + geom_abline(intercept = 0, slope = 1, color = "red", linetype = 2)

RMSE_out_list$Nitr_env_sim <- rmse(simple_simulation$netNitugPerGramPerDay, simple_simulation$env_sim_pred)
#####
effs + theme_classic(base_size = 20) + ylab("Coefficient")
scatter




#### N MINERALIZATION - ENV and SIMULATION #####

eval <- readRDS("/projectnb2/talbot-lab-data/zrwerbin/interactions/data/simulation_output/eval_summary.rds")
eval_pred <- eval %>% select(sampleID, moisture, diffusion, ammonium, nitrate, nmin, nitr)
new_master <- merge(eval_pred, soilData_harv)
new_master <- left_join(new_master, nitr_abun2, by = c("plot_date","horizon"))

simple_simulation <- new_master %>% select(netNitugPerGramPerDay, netNminugPerGramPerDay,
																					 soilMoisture, soilInCaClpH, d15N, CNratio,
																					 nitrogenPercent, `nitrifier_scaled`,
																					 initAmmonium, initNitrateNitrite, soilTemp,nmin,nitr) %>% drop_na()

simple_simulation <- scale(simple_simulation) %>% as.data.frame()

# Fit all parameter combinations
all.parms<-lm(netNminugPerGramPerDay ~ soilMoisture + initAmmonium  + CNratio +
								soilInCaClpH  + `nitrifier_scaled` +
								nitrogenPercent + d15N + initNitrateNitrite + nmin, data = simple_simulation)

results<-dredge(all.parms, fixed = "nmin")
#results<-dredge(all.parms, subset= !(d15N && nitrogenPercent))
MA.ests<-model.avg(results, subset= delta <= 3)
importance(MA.ests); summary(MA.ests)
best_model <- get.models(results, delta == 0)
effs <- plot_summs(best_model, scale = TRUE, robust=T, coefs = coeff_name_key)
effs + theme_classic(base_size = 20) + ylab("Coefficient")

simple_simulation$env_sim_pred <- predict(best_model[[1]])
ggscatter(simple_simulation, x = "env_sim_pred", y = "netNminugPerGramPerDay",
					add = "reg.line", conf.int = TRUE, shape = 21, size = 3) +
	stat_cor(aes(label = paste(..rr.label.., ..p.label.., sep = "~`,`~")),
					 label.x = -.5,
					 label.y = 3,
					 size=7) + theme_minimal(base_size=20) +
	xlab("Predicted N mineralization (ug/g/day)") + ylab("Observed N mineralization (ug/g/day)") +
	ggtitle("Environmental predictors & simulation results") + geom_abline(intercept = 0, slope = 1, color = "red", linetype = 2)


RMSE_out_list$Nmin_env_sim <- rmse(simple_simulation$netNminugPerGramPerDay,
																	 simple_simulation$env_sim_pred)
#####



#### N Ammonification - ENV and SIMULATION #####

eval <- readRDS("/projectnb2/talbot-lab-data/zrwerbin/interactions/data/simulation_output/eval_summary.rds")
eval_pred <- eval %>% select(sampleID, moisture, diffusion, ammonium, nitrate, nmin, nitr, ammo)
new_master <- merge(eval_pred, soilData_harv)
new_master <- left_join(new_master, nitr_abun2, by = c("plot_date","horizon"))

simple_simulation <- new_master %>% select(netAmmugPerGramPerDay,
																					 netNitugPerGramPerDay, netNminugPerGramPerDay,
																					 soilMoisture, soilInCaClpH, d15N, CNratio,
																					 nitrogenPercent, `nitrifier_scaled`,
																					 initAmmonium, initNitrateNitrite, soilTemp,nmin,nitr) %>% drop_na()

simple_simulation <- scale(simple_simulation) %>% as.data.frame()

# Fit all parameter combinations
all.parms<-lm(netAmmugPerGramPerDay ~ soilMoisture + initAmmonium  + CNratio +
								soilInCaClpH  + `nitrifier_scaled` +
								nitrogenPercent + d15N + initNitrateNitrite + nmin,
							data = simple_simulation)

results<-dredge(all.parms, fixed = "nmin")
#results<-dredge(all.parms, subset= !(d15N && nitrogenPercent))
MA.ests<-model.avg(results, subset= delta <= 3)
importance(MA.ests); summary(MA.ests)
best_model <- get.models(results, delta == 0)
effs <- plot_summs(best_model, scale = TRUE, robust=T, coefs = coeff_name_key)
effs <- effs + theme_classic(base_size = 20) + ylab("Coefficient")

simple_simulation$env_sim_pred <- predict(best_model[[1]])
scatter <- ggscatter(simple_simulation, x = "env_sim_pred", y = "netAmmugPerGramPerDay",
					add = "reg.line", conf.int = TRUE, shape = 21, size = 3) +
	stat_cor(aes(label = paste(..rr.label.., ..p.label.., sep = "~`,`~")),
					 label.x = -.5,
					 label.y = 3,
					 size=7) + theme_minimal(base_size=20) +
	xlab("Predicted ammonification (ug/g/day)") + ylab("Observed ammonification (ug/g/day)") +
	ggtitle("Environmental predictors & simulation results") + geom_abline(intercept = 0, slope = 1, color = "red", linetype = 2)


RMSE_out_list$Amm_env_sim <- rmse(simple_simulation$netAmmugPerGramPerDay,
																	 simple_simulation$env_sim_pred)
#####
effs
scatter



rmse_df <- stack(RMSE_out_list)
colnames(rmse_df) <- c("RMSE", "scenario")
rmse_df$trans <- substr(rmse_df$scenario, 1, 3)
rmse_df$trans <- ifelse(rmse_df$trans == "Nit", "Nitrification",
												ifelse(rmse_df$trans == "Amm", "Ammonification","N mineralization"))

rmse_df$predictors <- ifelse(grepl("env_sim", rmse_df$scenario),
														 "Metabolic simulation \n+ environmental",
														 ifelse(grepl("env_pathway", rmse_df$scenario),
														 			 "Genomic \n+ environmental",
														 			 "Environmental \nonly"))

ggplot(rmse_df, aes(y = RMSE, x = predictors, color = predictors)) +
	geom_point(size = 8, show.legend = F) +
	facet_grid(rows=vars(trans), scales="free") +
	theme_bw(base_size = 25) +
	xlab("Predictor types") +
	ylab("Root mean square error (RMSE)") +
	theme(axis.title.x = element_text(size= 20)) #+
#	scale_y_reverse()
#+ theme(axis.text.x = element_text(angle= 330))


rmse(simple_simulation$netNminugPerGramPerDay, simple_simulation$env_sim_pred)
rmse(simple_simulation$netNminugPerGramPerDay, simple_simulation$env_sim_pred)
rmse(simple_simulation$netNminugPerGramPerDay, simple_simulation$env_sim_pred)


site_descr <- readRDS(here("data/summary/site_effect_predictors.rds"))
site_descr$latitude <- round(site_descr$latitude, 1)
seasonality_in <- readRDS(here("data/summary/seasonalAmplitude.rds"))


season_site_df_cycl <- merge(site_descr, seasonality_in[[2]])
season_site_df_all_cov <- merge(site_descr, seasonality_in[[1]])




ggplot(season_site_df_cycl) +
	geom_point(aes(x = ecoregion, y = amplitude,
									#group = interaction(ecoregion, nlcd),

									#group = ecoregion,
									color = nlcd_clean),
							size=1, alpha = .2, na.rm = T, se = F) +
	#scale_x_date(breaks = "2 month") +
	xlab("Month") +
	ylab("Abundances (modeled)") +
	#facet_grid(rows = vars(taxon)) +
	facet_wrap(~taxon, scales="free") +
	ggtitle("Seasonal trends (all-covariate model)") +
	theme_bw(base_size = 18)





sum.all.tax_refit <- readRDS(here("data/summary/single_taxon_summaries_201511_202001.rds"))
tax_plot_est <- sum.all.tax_refit[[2]] %>% filter(model_name=="all_covariates")
tax_plot_est$month <- lubridate::month(tax_plot_est$dates)
tax_plot_est$month_label <- lubridate::month(tax_plot_est$dates, label = T)
tax_refit_site <- merge(tax_plot_est, site_descr)


# Merge seasonality with hindcast data
# All cov model
phylum_all_cov <-  tax_refit_site %>%
	filter(rank_only == "phylum") %>%
	distinct()

high_seasonality_tax <- cycl_vals %>% filter(amplitude > .15)

ggplot(phylum_all_cov %>% filter(taxon %in% high_seasonality_tax$taxon)) +
	geom_smooth(aes(x = month, y = `50%`,
									group = siteID,

									#group = ecoregion,
									color = latitude),
							size=1, alpha = .2, na.rm = T, se = F) +
	#scale_x_date(breaks = "2 month") +
	xlab("Month") +
	ylab("Abundances (modeled)") +
	#facet_grid(rows = vars(taxon)) +
	facet_wrap(~taxon, scales="free") +
	ggtitle("Seasonal trends (all-covariate model)") +
	theme_bw(base_size = 18)


#scores_list = readRDS(here("data", paste0("summary/scoring_metrics_cv.rds")))

# hindcast_wide_site from fig1 script
site_scores_descr <- merge(site_descr, hindcast_wide_site)
site_scores_descr <- merge(site_scores_descr, cycl_vals %>% select(-model_name))

site_effects_all <- readRDS(here("data/summary/site_effects.rds"))
site_effects_refit_only <- site_effects_all %>% filter(time_period == "2015-11_2020-01" &
																											 	model_name == "all_covariates") %>% mutate(site_effect = Mean)

site_scores_descr <- merge(site_scores_descr, site_effects_refit_only)


ggplot(site_scores_descr,
			 aes(x = latitude, y = CRPS_truncated)) +
	geom_point(aes(color = pretty_name), position = position_jitter(height=0, width=.1)) +
	geom_smooth(method="lm",
		size=1, alpha = .2) +
	facet_wrap(~pretty_name) +
	xlab("Site latitude") +
	ylab("Site hindcast accuracy") +
	theme_bw(base_size = 18) +labs(colour="Rank") +
	ggtitle("Hindcasts improve with proximity to equator") +
	stat_cor(aes(color = amplitude), label.x = 30)


ggscatter(site_scores_descr, #%>%
						#filter(pretty_name == "Functional group"),
					x = "latitude", y = "CRPS_truncated",
					add = "reg.line",                         # Add regression line
					color = "pretty_name" , fullrange = F,           # Color by groups "cyl"
)+
	stat_cor(aes(color = amplitude), label.x = 20) +
	labs(colour="Rank") +
	ggtitle("Hindcasts improve with proximity to equator") +
	xlab("Site latitude") +
	ylab("Site hindcast accuracy")




summary(lm(CRPS_truncated ~ latitude*amplitude, site_scores_descr))

ggplot(site_scores_descr,
			 aes(x = amplitude, y = CRPS_truncated, color = pretty_name)) +
	geom_point(show.legend = F) +
	geom_smooth(method="lm",
							size=1, alpha = .2, show.legend = F) +
	facet_wrap(~pretty_name) +
	xlab("Seasonal amplitude of taxon") +
	ylab("Site CRPS (hindcast accuracy)") +
	stat_cor(color=1) +
	theme_bw(base_size = 18) +
	ggtitle("Seasonality is associated with worse forecasts?")


ggplot(site_scores_descr,
			 aes(x = amplitude, y = latitude)) +
	geom_jitter(aes(color = CRPS_truncated, size = CRPS_truncated), alpha=.3) +
	xlab("Seasonal amplitude of taxon") +
	ylab("Latitude") +
	theme_bw(base_size = 18) +
	ggtitle("Seasonality & proximity from equator \nare associated with worse forecasts") +
	labs(color = "Hindcast accuracy", size = "Hindcast accuracy")




# Site effect ~ latitude
ggplot(site_scores_descr,
			 aes(x = site_effect, y = latitude)) +
	geom_jitter(aes(color = pretty_name), alpha=.3)  +
	facet_wrap(~pretty_name)

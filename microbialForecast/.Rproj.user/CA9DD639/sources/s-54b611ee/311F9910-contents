



site_eff_dredged_in <- readRDS(here("data/summary/site_effects_dredged.rds"))
unobs_sites <- readRDS(here("data/summary/site_effects_unobserved.rds"))

all.out <- site_eff_dredged_in[[1]]
pred_sites <- site_eff_dredged_in[[2]]

all.out <- all.out %>%
	group_by(predictor) %>%
	mutate(importance = round(mean(values), 2)) %>%
	ungroup() %>%
	#group_by(pretty_group, only_rank) %>%
	mutate(predictor = factor(predictor),
				 predictor = fct_reorder(predictor, importance))

all.out$predictor_category = recode(all.out$predictor, "siOxalate"  = "micronutrient",
																		"no2Satx" = "macronutrient",
																		"totalP" = "macronutrient",
																		"no3Satx" = "macronutrient",
																		"cecdNh4" = "cations",
																		"pOxalate"= "macronutrient",
																		"so4Satx"= "macronutrient",
																		"naNh4d" = "micronutrient",
																		"mnOxalate" = "micronutrient",
																		"MAT"	     = "climate",
																		"feOxalate" = "micronutrient",
																		"MAP"      = "climate",
																		"kNh4d"  = "macronutrient",
																		"caNh4d" = "macronutrient")

# FACET BY PREDICTOR
ggplot(all.out) + geom_point(aes(x = only_rank,
																 y = values,
																 color = pretty_group),
														 size=3, alpha = .2,
														 position=position_jitterdodge(dodge.width = 1, jitter.width = .1, jitter.height = .1)) +
	facet_wrap(~predictor, scale="free") +
	theme_bw() + theme(
		text = element_text(size = 16),
		axis.text.x=element_text(angle = 45, hjust = 1, vjust = 1),
		axis.title=element_text(size=22,face="bold")) + xlab(NULL) +
	ggtitle("Variables best explaining site random effects, across taxonomic ranks")

# FACET BY RANK
library(tidytext)
ggplot(all.out) + geom_point(aes(x = reorder_within(predictor, values, only_rank),
																 y = values,
																 color = pretty_group),
														 size=3, alpha = .2,
														 position=position_jitterdodge(dodge.width = 1, jitter.width = .1, jitter.height = .1)) +
	facet_wrap(~only_rank, scale="free") +
	theme_bw() + theme(
		text = element_text(size = 16),
		axis.text.x=element_text(angle = 45, hjust = 1, vjust = 1),
		axis.title=element_text(size=22,face="bold")) + xlab(NULL) +
	ggtitle("Variables best explaining site random effects")


all.out_filter = all.out %>% filter(taxon %in% pass_filter$taxon)


# FACET BY PREDICTOR and TYPE
library(tidytext)
ggplot(all.out_filter  %>% filter(only_rank != "functional"), aes(x = pretty_group,
																																	y = values,
																																	color = pretty_group)) +
	geom_point(aes(x = only_rank,
																			y = values,
																			color = pretty_group),
																	size=3, alpha = .2,
																	position=position_jitterdodge(dodge.width = 1, jitter.width = .1, jitter.height = .1)) +
			 	facet_wrap(predictor_category~predictor, scale="free") +
			 	theme_bw() + theme(
			 		text = element_text(size = 16),
			 		axis.text.x=element_text(angle = 45, hjust = 1, vjust = 1),
			 		axis.title=element_text(size=22,face="bold")) + xlab(NULL) +
	ylab("Variable importance") +
			 	ggtitle("Variables best explaining site random effects")


# FACET BY PREDICTOR TYPE, compare by MICROBIAL DOMAIN

ggplot(all.out_filter %>% filter(only_rank != "functional"), aes(x = pretty_group,
										y = values,
										color = pretty_group)) +
	geom_violin(draw_quantiles = c(.5), show.legend = F) +
	geom_point(
		size=3, alpha = .1,
		position=position_jitterdodge(dodge.width = 1, jitter.width = .2, jitter.height = 0), show.legend = F) +
	#facet_wrap(predictor_category~paste(predictor, importance),, scale="free") +
	facet_wrap(~predictor_category, scale="free") +
	stat_compare_means(method = "t.test", aes(label = ..p.signif..), label.x = 1.5, label.y = .75, show.legend = F) +
	ylab("Variable importance") +
	theme_bw() + theme(
		text = element_text(size = 16),
		axis.text.x=element_text(angle = 45, hjust = 1, vjust = 1),
		axis.title=element_text(size=18)) + xlab(NULL) +
	ggtitle("Variables best explaining site random effects (taxa only)")


# FACET BY PREDICTOR, compare by MICROBIAL DOMAIN
ggplot(all.out_filter  %>% filter(only_rank != "functional"), aes(x = pretty_group,
																																	y = values,
																																	color = pretty_group)) +
	geom_point(aes(x = pretty_group,
								 y = values,
								 color = pretty_group),
						 size=3, alpha = .2,
						 position=position_jitterdodge(dodge.width = 1, jitter.width = .1, jitter.height = .1)) +
	geom_violin(draw_quantiles = c(.5))+
	facet_wrap(predictor_category~predictor, scale="free") +
	theme_bw() + theme(
		text = element_text(size = 16),
		axis.text.x=element_text(angle = 45, hjust = 1, vjust = 1),
		axis.title=element_text(size=22,face="bold")) + xlab(NULL) +
	ylab("Variable importance") +
	ggtitle("Variables best explaining site random effects") +
	stat_compare_means(method = "t.test", aes(label = ..p.signif..), label.x = 1.5, label.y = .75, show.legend = F)

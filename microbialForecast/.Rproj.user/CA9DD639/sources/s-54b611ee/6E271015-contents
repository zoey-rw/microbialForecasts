library(tidyverse)
library(ggplot2)
library(broom)
library(tidycat)

all_fam_df <- readRDS("/projectnb2/talbot-lab-data/zrwerbin/interactions/fam_abund.rds") %>% filter(percentage>0)


# VISUALIZE OUR 6 CURRENT GENERA
fam_list <- c("f_Nitratiruptoraceae", "f_Nitrosomonadaceae", "f_Nitrosopumilaceae", 
								 "f_Nitrososphaeraceae", "f_Nitrospiraceae")
fam_df <- all_fam_df %>% 
	#filter(!plotID %in% c("HARV_010","HARV_021","HARV_033")) %>% 
	filter(name %in% fam_list)

fam_df_info <- cbind(parseNEONsampleIDs(fam_df$sampleID))

fam_df_scaled <- fam_df %>% group_by(name) %>% mutate(scaled_percent = scale(percentage))
fam_df_scaled$siteID <- fam_df_info$siteID
fam_df_scaled$plot_date <- fam_df_info$plot_date
fam_df_scaled$horizon <- fam_df_info$horizon

ggplot(fam_df_scaled) + 
	geom_point(aes(y = horizon, 
								 x = siteID, 
								 #fill = scaled_percent, 
								 color = scaled_percent,
								 size = scaled_percent), 
						 position=position_jitter()) + 
	facet_grid(~name, scales="free") + scale_color_gradient(low = "blue", high = "red")


fam_nitrospira <- fam_df_scaled %>% filter(name == "f_Nitrospiraceae")


lm_out <- list()
for (fam in fam_list){
	print(fam)
	df <- fam_df_scaled %>% filter(name == fam)
	if (nrow(df)==0) next()
  fam_lm <- tidy(lm(scaled_percent ~ as.factor(horizon), df))
  fam_lm$name <- fam
	lm_out[[fam]] <- fam_lm
}
lm_out <- do.call(rbind, lm_out)
horizon_coef <- lm_out %>% filter(grepl("horizon", term))
horizon_coef$indicator <- ifelse(horizon_coef$p.value < .1, T, F)
fam_df_scaled <- merge(fam_df_scaled, horizon_coef)
